{% extends "layout.html" %}

{% block title %}Betting Center - Hoops Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Betting Statistics Dashboard -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-6">Betting Center</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-500">Total Bets</div>
                <div class="text-2xl font-bold">{{ stats.total_bets or 0 }}</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-500">Win Rate</div>
                <div class="text-2xl font-bold {{ 'text-green-600' if stats.win_rate > 50 else 'text-red-600' }}">
                    {{ stats.win_rate or 0 }}%
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-500">Profit/Loss</div>
                <div class="text-2xl font-bold {{ 'text-green-600' if (stats.profit_loss or 0) > 0 else 'text-red-600' }}">
                    ${{ "%.2f"|format(stats.profit_loss or 0) }}
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-500">ROI</div>
                <div class="text-2xl font-bold {{ 'text-green-600' if (stats.roi or 0) > 0 else 'text-red-600' }}">
                    {{ stats.roi or 0 }}%
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Place New Bet -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Place New Bet</h2>
                
                <form method="post" id="betting-form" class="space-y-4">
                    <!-- Player Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Player</label>
                        <select name="player_id" id="player-select" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select a player...</option>
                            {% for player in popular_players %}
                            <option value="{{ player.id }}">
                                {{ player.name }} - {{ player.teams.abbreviation if player.teams else 'FA' }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Stat Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stat Type</label>
                        <select name="stat_key" id="stat-select" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select stat...</option>
                            <option value="pts">Points</option>
                            <option value="reb">Rebounds</option>
                            <option value="ast">Assists</option>
                            <option value="stl">Steals</option>
                            <option value="blk">Blocks</option>
                            <option value="fg3_made">3-Pointers Made</option>
                        </select>
                    </div>

                    <!-- Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Threshold</label>
                        <input type="number" name="threshold" id="threshold-input" step="0.5" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., 25.5">
                    </div>

                    <!-- Over/Under -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bet Type</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="side" value="over" required class="mr-2">
                                <span class="font-medium">Over</span>
                            </label>
                            <label class="flex items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="side" value="under" required class="mr-2">
                                <span class="font-medium">Under</span>
                            </label>
                        </div>
                    </div>

                    <!-- Stake -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stake ($)</label>
                        <input type="number" name="stake" value="10" min="1" max="100" step="1" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Odds Display -->
                    <div id="odds-display" class="hidden bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-sm text-gray-500">Over Odds</div>
                                <div id="over-odds" class="text-lg font-bold">-</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-500">Under Odds</div>
                                <div id="under-odds" class="text-lg font-bold">-</div>
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="text-sm text-gray-500">Confidence: <span id="confidence-level">-</span></div>
                            <div class="text-sm text-gray-500">Potential Payout: $<span id="potential-payout">0.00</span></div>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Place Bet
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                <div class="space-y-2">
                    <button onclick="resolveAllBets()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                        Simulate All Pending Bets
                    </button>
                    <button onclick="showBettingTips()" 
                            class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">
                        Betting Tips
                    </button>
                </div>
            </div>

            <!-- Betting Tips -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Smart Betting Tips</h3>
                <ul class="text-sm text-gray-600 space-y-2">
                    <li>• Check recent player performance</li>
                    <li>• Consider matchup difficulty</li>
                    <li>• Look for high-confidence bets</li>
                    <li>• Manage your bankroll wisely</li>
                    <li>• Track your betting patterns</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Betting History -->
    <div class="mt-8">
        <h2 class="text-2xl font-semibold mb-4">Recent Bets</h2>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bet</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odds</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stake</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for bet in bets %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">{{ bet.players.name }}</div>
                            <div class="text-sm text-gray-500">{{ bet.players.teams.abbreviation if bet.players.teams else 'FA' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium">{{ bet.side.title() }} {{ bet.threshold }}</div>
                            <div class="text-sm text-gray-500">{{ bet.stat_key.upper() }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "%.2f"|format(bet.odds) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${{ "%.2f"|format(bet.stake) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if bet.status == 'won' %}bg-green-100 text-green-800
                                {% elif bet.status == 'lost' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ bet.status.title() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if bet.result_value %}
                                <div class="font-medium">{{ bet.result_value }}</div>
                                {% if bet.status == 'won' %}
                                    <div class="text-green-600">+${{ "%.2f"|format((bet.potential_payout or 0) - bet.stake) }}</div>
                                {% elif bet.status == 'lost' %}
                                    <div class="text-red-600">-${{ "%.2f"|format(bet.stake) }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">Pending</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if bet.status == 'pending' %}
                                <button onclick="simulateBet('{{ bet.id }}')" 
                                        class="text-blue-600 hover:text-blue-900">Simulate</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Betting interface JavaScript
let currentOdds = null;

// Load odds when bet parameters change
function updateOdds() {
    const playerId = document.getElementById('player-select').value;
    const statKey = document.getElementById('stat-select').value;
    const threshold = document.getElementById('threshold-input').value;
    
    if (playerId && statKey && threshold) {
        fetch(`/api/betting/odds?player_id=${playerId}&stat_key=${statKey}&threshold=${threshold}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('odds-display').classList.add('hidden');
                    alert(data.error);
                } else {
                    currentOdds = data;
                    displayOdds(data);
                    updatePotentialPayout();
                }
            })
            .catch(error => console.error('Error fetching odds:', error));
    }
}

function displayOdds(odds) {
    document.getElementById('over-odds').textContent = odds.odds.over;
    document.getElementById('under-odds').textContent = odds.odds.under;
    document.getElementById('confidence-level').textContent = odds.confidence;
    document.getElementById('odds-display').classList.remove('hidden');
}

function updatePotentialPayout() {
    if (!currentOdds) return;
    
    const stake = parseFloat(document.querySelector('input[name="stake"]').value) || 0;
    const selectedSide = document.querySelector('input[name="side"]:checked')?.value;
    
    if (selectedSide && currentOdds.odds[selectedSide]) {
        const payout = stake * currentOdds.odds[selectedSide];
        document.getElementById('potential-payout').textContent = payout.toFixed(2);
    }
}

function simulateBet(betId) {
    fetch(`/api/betting/simulate/${betId}`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert(`Bet ${data.outcome}! Result: ${data.simulated_value} (${data.side} ${data.threshold})`);
                location.reload();
            }
        })
        .catch(error => console.error('Error simulating bet:', error));
}

function resolveAllBets() {
    if (confirm('Simulate outcomes for all pending bets?')) {
        fetch('/api/betting/resolve-all', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(`Resolved ${data.resolved} bets!`);
                    location.reload();
                }
            })
            .catch(error => console.error('Error resolving bets:', error));
    }
}

// Event listeners
document.getElementById('player-select').addEventListener('change', updateOdds);
document.getElementById('stat-select').addEventListener('change', updateOdds);
document.getElementById('threshold-input').addEventListener('input', updateOdds);
document.querySelector('input[name="stake"]').addEventListener('input', updatePotentialPayout);
document.querySelectorAll('input[name="side"]').forEach(radio => {
    radio.addEventListener('change', updatePotentialPayout);
});
</script>
{% endblock %}