{% extends "base.html" %}

{% block title %}{{ roster.name }} - Hoops Tracker{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="roster-icon me-3">
                                    <i class="bi bi-list-ul display-4 text-primary"></i>
                                </div>
                                <div>
                                    <h2 class="mb-1">{{ roster.name }}</h2>
                                    {% if roster.description %}
                                    <p class="text-muted mb-2">{{ roster.description }}</p>
                                    {% endif %}
                                    <div class="roster-meta">
                                        <small class="text-muted me-3">
                                            <i class="bi bi-people"></i> {{ roster_players|length }}/15 Players
                                        </small>
                                        <small class="text-muted me-3">
                                            {% if roster.is_public %}
                                                <i class="bi bi-globe text-success"></i> Public
                                            {% else %}
                                                <i class="bi bi-lock text-warning"></i> Private
                                            {% endif %}
                                        </small>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> Created {{ roster.created_at|date if roster.created_at else 'Recently' }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                                <i class="bi bi-plus-circle"></i> Add Player
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editRoster()">
                                        <i class="bi bi-pencil"></i> Edit Roster
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="shareRoster()">
                                        <i class="bi bi-share"></i> Share Roster
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoster()">
                                        <i class="bi bi-trash"></i> Delete Roster
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- Stats Section -->
	{% if roster_players %}
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5><i class="bi bi-bar-chart"></i> Roster Statistics</h5>
				</div>
				<div class="card-body">
					<div class="row text-center g-3">
						<div class="col-6 col-lg-3">
							<div class="stat-box">
								<div class="stat-value" id="avg-points">-</div>
								<div class="stat-label">Avg Points</div>
							</div>
						</div>
						<div class="col-6 col-lg-3">
							<div class="stat-box">
								<div class="stat-value" id="avg-rebounds">-</div>
								<div class="stat-label">Avg Rebounds</div>
							</div>
						</div>
						<div class="col-6 col-lg-3">
							<div class="stat-box">
								<div class="stat-value" id="avg-assists">-</div>
								<div class="stat-label">Avg Assists</div>
							</div>
						</div>
						<div class="col-6 col-lg-3">
							<div class="stat-box">
								<div class="stat-value" id="total-players">-</div>
								<div class="stat-label">Total Players</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}

    <!-- Players Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Roster Players</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="changeView('grid')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changeView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if roster_players %}
                    <!-- Grid View (Default) -->
                    <div id="grid-view">
                        <div class="row">
                            {% for roster_player in roster_players %}
                            {% set player = roster_player.players %}
                            {% if player %}
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-4">
                                <div class="card player-card" onclick="window.location.href='{{ url_for('player_detail', player_id=player.id) }}'">
                                    <div class="player-card-header">
                                        <button class="btn btn-sm btn-outline-danger remove-player-btn" 
                                                onclick="event.stopPropagation(); removePlayer({{ player.id }})"
                                                title="Remove from roster">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <div class="card-body text-center p-3">
                                        <div class="player-image-container mb-2">
                                            <img src="{{ get_player_headshot_url(player.nba_player_id) if player.nba_player_id else '/static/img/default-player.png' }}" 
                                                 class="player-headshot" 
                                                 alt="{{ player.first_name }} {{ player.last_name }}"
                                                 onerror="this.src='/static/img/default-player.png'">
                                        </div>
                                        
                                        <h6 class="card-title mb-1">
                                            {{ player.first_name }} {{ player.last_name }}
                                        </h6>
                                        
                                        {% if player.teams %}
                                        <small class="text-muted d-block mb-1">{{ player.teams.abbreviation }}</small>
                                        {% endif %}
                                        
                                        <div class="player-badges mb-2">
                                            {% if player.position %}
                                            <span class="badge bg-secondary">{{ player.position }}</span>
                                            {% endif %}
                                            {% if player.jersey_number %}
                                            <span class="badge bg-primary">#{{ player.jersey_number }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="player-stats">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <small class="stat-number">{{ "%.1f"|format(player.avg_points or player.points_per_game or 0) }}</small>
                                                    <small class="stat-label d-block">PTS</small>
                                                </div>
                                                <div class="col-4">
													<small class="stat-number">{{ "%.1f"|format(player.avg_rebounds or player.rebounds_per_game or 0) }}</small>
													<small class="stat-label d-block">REB</small>
                                                </div>
                                                <div class="col-4">
                                                    <small class="stat-number">{{ "%.1f"|format(player.avg_assists or player.assists_per_game or 0) }}</small>
													<small class="stat-label d-block">AST</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- List View (Hidden by default) -->
                    <div id="list-view" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th>Pos</th>
                                        <th>#</th>
                                        <th>PTS</th>
                                        <th>REB</th>
                                        <th>AST</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for roster_player in roster_players %}
                                    {% set player = roster_player.players %}
                                    {% if player %}
                                    <tr onclick="window.location.href='{{ url_for('player_detail', player_id=player.id) }}'" style="cursor: pointer;">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="{{ get_player_headshot_url(player.nba_player_id) if player.nba_player_id else '/static/img/default-player.png' }}" 
                                                     class="player-headshot-small me-2" 
                                                     alt="{{ player.first_name }} {{ player.last_name }}"
                                                     onerror="this.src='/static/img/default-player.png'">
                                                <div>
                                                    <strong>{{ player.first_name }} {{ player.last_name }}</strong>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if player.teams %}
                                                {{ player.teams.abbreviation }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>{{ player.position or '-' }}</td>
                                        <td>{{ player.jersey_number or '-' }}</td>
										<td><strong>{{ "%.1f"|format(player.avg_points or player.points_per_game or 0) }}</strong></td>
										<td>{{ "%.1f"|format(player.avg_rebounds or player.rebounds_per_game or 0) }}</td>
										<td>{{ "%.1f"|format(player.avg_assists or player.assists_per_game or 0) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="event.stopPropagation(); removePlayer({{ player.id }})"
                                                    title="Remove from roster">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-roster text-center py-5">
                        <i class="bi bi-people display-1 text-muted mb-3"></i>
                        <h4 class="text-muted">No players in this roster</h4>
                        <p class="text-muted mb-4">Start building your roster by adding players</p>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                            <i class="bi bi-plus-circle"></i> Add Your First Player
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Add Player Modal -->
{% block modals %}

<div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPlayerModalLabel">Add Player to Roster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="playerSearch" class="form-label">Search Players</label>
                    <input type="text" class="form-control" id="playerSearch" placeholder="Type player name..." autocomplete="off">
                </div>
                <div id="playerSearchResults" class="search-results" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search display-4"></i>
                        <p class="mt-2 mb-0">Start typing to search for players</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Roster Modal -->
<div class="modal fade" id="editRosterModal" tabindex="-1" aria-labelledby="editRosterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRosterModalLabel">Edit Roster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRosterForm">
                    <div class="mb-3">
                        <label for="editRosterName" class="form-label">Roster Name</label>
                        <input type="text" class="form-control" id="editRosterName" value="{{ roster.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRosterDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editRosterDescription" rows="3" placeholder="Optional description">{{ roster.description or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editRosterPublic" {{ 'checked' if roster.is_public else '' }}>
                            <label class="form-check-label" for="editRosterPublic">
                                Make this roster public
                            </label>
                            <div class="form-text">Public rosters can be viewed by other users</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRosterEdits()">
                    <i class="bi bi-check-circle"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Roster Modal -->
<div class="modal fade" id="shareRosterModal" tabindex="-1" aria-labelledby="shareRosterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareRosterModalLabel">Share Roster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rosterShareLink" class="form-label">Share Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rosterShareLink" readonly value="{{ request.url }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyShareLink()">
                            <i class="bi bi-copy"></i> Copy
                        </button>
                    </div>
                    <div class="form-text">Share this link with others to let them view your roster</div>
                </div>
                
                {% if not roster.is_public %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>This roster is private.</strong> 
                    Only you can view it. Make it public in roster settings to share with others.
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-outline-primary w-100" onclick="shareToTwitter()">
                            <i class="bi bi-twitter"></i> Twitter
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-primary w-100" onclick="shareToFacebook()">
                            <i class="bi bi-facebook"></i> Facebook
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteRosterModal" tabindex="-1" aria-labelledby="deleteRosterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRosterModalLabel">Delete Roster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle display-1 text-danger mb-3"></i>
                    <h4>Are you sure?</h4>
                    <p class="text-muted">
                        This will permanently delete "<strong>{{ roster.name }}</strong>" and remove all players from it. 
                        This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRoster()">
                    <i class="bi bi-trash"></i> Delete Roster
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<style>
/* Roster header styling */
.roster-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-bg);
    border-radius: 10px;
}

.roster-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

/* Stats boxes */
.stat-box {
    padding: 1rem;
    background-color: var(--light-bg);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

/* Enhanced player cards with better proportions */
.player-card {
    height: 320px; /* Slightly taller for better proportions */
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #dee2e6;
    position: relative;
    display: flex;
    flex-direction: column;
}

.player-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.player-card-header {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
}

.remove-player-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #dc3545;
}

.player-card:hover .remove-player-btn {
    opacity: 1;
}

.card-body {
    padding: 1rem 0.75rem;
    display: flex;
    flex-direction: column;
    height: 100%;
    text-align: center;
}

.player-image-container {
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    flex-shrink: 0;
    overflow: hidden;
}

.player-headshot {
    width: 75px;
    height: 75px;
    object-fit: cover;
    object-position: center 15%; /* Adjusted to focus more on face */
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    display: block;
    background-color: #f8f9fa;
    transition: transform 0.2s ease;
    /* Add these new properties for better cropping */
    image-rendering: crisp-edges;
    image-rendering: -webkit-optimize-contrast;
}

.player-headshot:hover {
    transform: scale(1.08);
}

.player-headshot-small {
    width: 35px;
    height: 35px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #dee2e6;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    min-height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.3;
    flex-shrink: 0;
}

.text-muted {
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    flex-shrink: 0;
}

.player-badges {
    min-height: 32px;
    margin-bottom: 0.75rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.player-badges .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.player-stats {
    margin-top: auto;
    padding-top: 0.5rem;
    border-top: 1px solid #f0f0f0;
}

.stat-number {
    font-weight: bold;
    color: var(--bs-primary);
    font-size: 1rem;
    display: block;
    margin-bottom: 0.1rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 500;
}

/* Search results styling */
.search-results .player-result {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-results .player-result:hover {
    background-color: #f8f9fa;
}

.search-results .player-result:last-child {
    margin-bottom: 0;
}

/* Empty roster styling */
.empty-roster {
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .player-card {
        height: 300px;
    }
    
    .player-headshot {
        width: 70px;
        height: 70px;
    }
    
    .player-image-container {
        height: 85px;
    }
}

@media (max-width: 768px) {
    .player-card {
        height: 280px;
    }
    
    .player-headshot {
        width: 60px;
        height: 60px;
    }
    
    .player-image-container {
        height: 75px;
        margin-bottom: 10px;
    }
    
    .card-title {
        font-size: 0.9rem;
        min-height: 2.2rem;
    }
    
    .card-body {
        padding: 0.75rem 0.5rem;
    }
    
    .stat-number {
        font-size: 0.9rem;
    }
    
    .roster-meta {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .stat-box {
        padding: 0.75rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
}

@media (max-width: 576px) {
    .player-card {
        height: 260px;
    }
    
    .player-headshot {
        width: 55px;
        height: 55px;
    }
    
    .player-image-container {
        height: 70px;
    }
    
    .card-title {
        font-size: 0.85rem;
        min-height: 2rem;
    }
    
    .player-badges .badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
}

/* Grid responsiveness - better column distribution */
@media (min-width: 1400px) {
    .col-xl-2 {
        flex: 0 0 auto;
        width: 16.66666667%; /* 6 cards per row on very large screens */
    }
}

@media (min-width: 1200px) and (max-width: 1399px) {
    .col-xl-2 {
        flex: 0 0 auto;
        width: 20%; /* 5 cards per row on large screens */
    }
}

@media (min-width: 992px) and (max-width: 1199px) {
    .col-lg-3 {
        flex: 0 0 auto;
        width: 25%; /* 4 cards per row on medium screens */
    }
}

@media (min-width: 768px) and (max-width: 991px) {
    .col-md-4 {
        flex: 0 0 auto;
        width: 33.33333333%; /* 3 cards per row on tablets */
    }
}

@media (max-width: 767px) {
    .col-sm-6 {
        flex: 0 0 auto;
        width: 50%; /* 2 cards per row on mobile */
    }
}
</style>

{% block extra_scripts %}
<script>
let searchTimeout;

document.addEventListener('DOMContentLoaded', function() {
    calculateRosterStats();
    initializePlayerSearch();
});

function calculateRosterStats() {
    const rosterPlayers = {{ roster_players|tojson if roster_players else '[]' }};
    
    if (rosterPlayers.length === 0) return;
    
    let totalPoints = 0;
    let totalRebounds = 0;
    let totalAssists = 0;
    let playersWithStats = 0;
    
    rosterPlayers.forEach(rosterPlayer => {
        const player = rosterPlayer.players;
        if (player) {
            // Check multiple possible stat properties
            const points = parseFloat(player.avg_points || player.points_per_game || 0);
            const rebounds = parseFloat(player.avg_rebounds || player.rebounds_per_game || 0);
            const assists = parseFloat(player.avg_assists || player.assists_per_game || 0);
            
            console.log(`Player ${player.first_name} ${player.last_name}:`, {
                raw_points: player.avg_points,
                raw_rebounds: player.avg_rebounds, 
                raw_assists: player.avg_assists,
                calculated: {points, rebounds, assists}
            });
            
            totalPoints += points;
            totalRebounds += rebounds;
            totalAssists += assists;
            
            if (points > 0 || rebounds > 0 || assists > 0) {
                playersWithStats++;
            }
        }
    });
    
    console.log('Roster totals:', {totalPoints, totalRebounds, totalAssists, playersWithStats});
    
    // Update display
    const avgPoints = playersWithStats > 0 ? (totalPoints / playersWithStats).toFixed(1) : '0.0';
    const avgRebounds = playersWithStats > 0 ? (totalRebounds / playersWithStats).toFixed(1) : '0.0';
    const avgAssists = playersWithStats > 0 ? (totalAssists / playersWithStats).toFixed(1) : '0.0';
    
    document.getElementById('avg-points').textContent = avgPoints;
    document.getElementById('avg-rebounds').textContent = avgRebounds;
    document.getElementById('avg-assists').textContent = avgAssists;
    document.getElementById('total-players').textContent = rosterPlayers.length;
    
    console.log('Updated stats display:', {avgPoints, avgRebounds, avgAssists});
}

function changeView(viewType) {
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (viewType === 'grid') {
        gridView.style.display = 'block';
        listView.style.display = 'none';
        buttons[0].classList.add('active');
    } else {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        buttons[1].classList.add('active');
    }
}

function initializePlayerSearch() {
    const searchInput = document.getElementById('playerSearch');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            showSearchMessage('Start typing to search for players');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchPlayers(query);
        }, 300);
    });
}

async function searchPlayers(query) {
    const resultsContainer = document.getElementById('playerSearchResults');
    
    // Show loading
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted mb-0">Searching players...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&type=players&limit=10`);
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data.players && result.data.players.length > 0) {
                displaySearchResults(result.data.players);
            } else {
                showSearchMessage('No players found');
            }
        } else {
            throw new Error('Search failed');
        }
    } catch (error) {
        console.error('Search error:', error);
        showSearchMessage('Error searching players. Please try again.');
    }
}

function displaySearchResults(players) {
    const resultsContainer = document.getElementById('playerSearchResults');
    
    resultsContainer.innerHTML = players.map(player => `
        <div class="player-result" onclick="addPlayerToRoster(${player.id})">
            <div class="d-flex align-items-center">
                <img src="${getPlayerHeadshotUrl(player.nba_player_id)}" 
                     class="player-headshot-small me-3" 
                     alt="${player.first_name} ${player.last_name}"
                     onerror="this.src='/static/img/default-player.png'">
                <div class="flex-grow-1">
                    <div class="fw-bold">${player.first_name} ${player.last_name}</div>
                    <small class="text-muted">
                        ${player.teams ? player.teams.name : 'No team'} 
                        ${player.position ? `• ${player.position}` : ''}
                        ${player.jersey_number ? `• #${player.jersey_number}` : ''}
                    </small>
                </div>
                <div class="text-end">
                    <button class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Add
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function showSearchMessage(message) {
    const resultsContainer = document.getElementById('playerSearchResults');
    resultsContainer.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="bi bi-search display-4"></i>
            <p class="mt-2 mb-0">${message}</p>
        </div>
    `;
}

function getPlayerHeadshotUrl(nbaPlayerId) {
    return nbaPlayerId ? 
        `https://ak-static.cms.nba.com/wp-content/uploads/headshots/nba/latest/260x190/${nbaPlayerId}.png` :
        '/static/img/default-player.png';
}

async function addPlayerToRoster(playerId) {
    try {
        const response = await fetch(`/api/rosters/{{ roster.id }}/players`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player_id: playerId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof HoopsTracker !== 'undefined') {
                HoopsTracker.showToast('Player added to roster successfully!', 'success');
            }
            
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPlayerModal'));
            modal.hide();
            
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(result.error || 'Failed to add player');
        }
        
    } catch (error) {
        console.error('Error adding player:', error);
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Error: ' + error.message, 'danger');
        } else {
            alert('Error: ' + error.message);
        }
    }
}

async function removePlayer(playerId) {
    if (!confirm('Are you sure you want to remove this player from the roster?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/rosters/{{ roster.id }}/players?player_id=${playerId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof HoopsTracker !== 'undefined') {
                HoopsTracker.showToast('Player removed from roster', 'success');
            }
            
            // Reload page to reflect changes
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(result.error || 'Failed to remove player');
        }
        
    } catch (error) {
        console.error('Error removing player:', error);
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Error: ' + error.message, 'danger');
        } else {
            alert('Error: ' + error.message);
        }
    }
}

function editRoster() {
    const modal = new bootstrap.Modal(document.getElementById('editRosterModal'));
    modal.show();
}

function shareRoster() {
    const modal = new bootstrap.Modal(document.getElementById('shareRosterModal'));
    modal.show();
}

function deleteRoster() {
    const modal = new bootstrap.Modal(document.getElementById('deleteRosterModal'));
    modal.show();
}

async function saveRosterEdits() {
    const name = document.getElementById('editRosterName').value.trim();
    const description = document.getElementById('editRosterDescription').value.trim();
    const isPublic = document.getElementById('editRosterPublic').checked;
    
    if (!name) {
        alert('Roster name is required');
        return;
    }
    
    try {
        const response = await fetch(`/api/rosters/{{ roster.id }}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                description: description,
                is_public: isPublic
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof HoopsTracker !== 'undefined') {
                HoopsTracker.showToast('Roster updated successfully!', 'success');
            }
            
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRosterModal'));
            modal.hide();
            
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(result.error || 'Failed to update roster');
        }
        
    } catch (error) {
        console.error('Error updating roster:', error);
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Error: ' + error.message, 'danger');
        } else {
            alert('Error: ' + error.message);
        }
    }
}

function copyShareLink() {
    const shareLink = document.getElementById('rosterShareLink');
    shareLink.select();
    shareLink.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Link copied to clipboard!', 'success');
        } else {
            alert('Link copied to clipboard!');
        }
    } catch (err) {
        console.error('Failed to copy link:', err);
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Failed to copy link', 'danger');
        }
    }
}

function shareToTwitter() {
    const text = `Check out my NBA roster: {{ roster.name }}`;
    const url = encodeURIComponent(window.location.href);
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`;
    window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
}

async function confirmDeleteRoster() {
    try {
        const response = await fetch(`/api/rosters/{{ roster.id }}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof HoopsTracker !== 'undefined') {
                HoopsTracker.showToast('Roster deleted successfully', 'success');
            }
            
            // Redirect to rosters page
            window.location.href = '/rosters';
        } else {
            throw new Error(result.error || 'Failed to delete roster');
        }
        
    } catch (error) {
        console.error('Error deleting roster:', error);
        if (typeof HoopsTracker !== 'undefined') {
            HoopsTracker.showToast('Error: ' + error.message, 'danger');
        } else {
            alert('Error: ' + error.message);
        }
    }
}
</script>
{% endblock %}
